envs:
  S3_BUCKET: nebius://henry-test  # S3 bucket for checkpoints
  S3_BUCKET2: nebius://henry-test-et  # S3 bucket for checkpoints
  HF_TOKEN:  # Add your HuggingFace token if needed

resources:
  # cloud: aws
  # region: us-west-2  # Ensure compute is in same region as S3 bucket
  cpus: 32+
  memory: 256+
  disk_tier: best
  disk_size: 2000
  accelerators: H100:8
  network_tier: best
  image_id: docker:cr.eu-north1.nebius.cloud/nebius-benchmarks/nccl-tests:2.23.4-ubu22.04-cu12.4

num_nodes: 2

# Configure buckets for dataset and checkpoints with both S3 and local NVMe
file_mounts:
  /checkpoints_s3:
    source: ${S3_BUCKET}
    mode: MOUNT
  /checkpoints_s3_mount_cached:
    source: ${S3_BUCKET2}
    mode: MOUNT_CACHED
  /e2e: ./e2e

volumes:
  # Mount the Nebius shared filesystem to /mnt/data across all nodes
  /mnt/data: nebius-pvc

setup: |
  conda install cuda -c nvidia
  uv venv ~/training --seed --python 3.10; source ~/training/bin/activate
  uv pip install torch torchvision torchaudio
  uv pip install accelerate trl deepspeed liger-kernel
  sudo DEBIAN_FRONTEND=noninteractive apt install -y vmtouch vim
  sudo DEBIAN_FRONTEND=noninteractive apt install -y python3-dev python3.10-dev build-essential

  # Other tools
  sudo DEBIAN_FRONTEND=noninteractive apt install -y htop sysstat iproute2 net-tools infiniband-diags
  uv pip install nvitop

  mkdir /tmp/checkpoint

run: |
  source ~/training/bin/activate

  MASTER_ADDR=$(echo "$SKYPILOT_NODE_IPS" | head -n1)
  NP=$(($SKYPILOT_NUM_GPUS_PER_NODE * $SKYPILOT_NUM_NODES))

  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py
  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py --dirs /tmp/checkpoint /mnt/data/checkpoint /checkpoints_s3 /checkpoints_s3_mount_cached
  python /e2e/download.py --num_proc -1 --dirs /tmp/checkpoint /mnt/data /checkpoints_s3 /checkpoints_s3_mount_cached
  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py --num_proc -1 --dirs /tmp/checkpoint /mnt/data/checkpoint /checkpoints_s3 /checkpoints_s3_mount_cached

  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py --num_proc -1 --dirs /tmp/checkpoint
  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py --num_proc -1 --dirs /mnt/data/
  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py --num_proc -1 --dirs /checkpoints_s3
  # accelerate launch --config_file /e2e/deepspeed_zero3.yaml /e2e/train.py --num_proc -1 --dirs /checkpoints_s3_mount_cached

  # accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --enable_profiling --dirs /tmp/checkpoint
  # cp /tmp/trace_* /tmp/checkpoint/checkpoints
  # accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --enable_profiling --dirs /mnt/data/
  # cp /tmp/trace_* /mnt/data/checkpoint/checkpoints
  # accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --enable_profiling --dirs /checkpoints_s3
  # cp /tmp/trace_* /checkpoints_s3/checkpoints
  # accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --enable_profiling --dirs /checkpoints_s3_mount_cached
  # cp /tmp/trace_* /checkpoints_s3_mount_cached/checkpoints

  accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --dirs /tmp/checkpoint
  cp /tmp/trace_* /tmp/checkpoint/checkpoints
  accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --dirs /mnt/data/
  cp /tmp/trace_* /mnt/data/checkpoint/checkpoints
  accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --dirs /checkpoints_s3
  cp /tmp/trace_* /checkpoints_s3/checkpoints
  accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/train.py --num_proc 32 --dirs /checkpoints_s3_mount_cached
  cp /tmp/trace_* /checkpoints_s3_mount_cached/checkpoints


config:
  kubernetes:
    pod_config:
      spec:
        containers:
        - securityContext:
            capabilities:
              add:
              - IPC_LOCK
              - SYS_ADMIN
              - SYS_PTRACE
              - SYS_RESOURCE
              - NET_ADMIN