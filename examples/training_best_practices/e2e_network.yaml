resources:
  infra: k8s
  accelerators: H100:8
  network_tier: best
  image_id: docker:cr.eu-north1.nebius.cloud/nebius-benchmarks/nccl-tests:2.23.4-ubu22.04-cu12.4

file_mounts:
  /e2e: ./e2e

num_nodes: 2

setup: |
  conda install cuda -c nvidia
  uv venv ~/training --seed --python 3.10
  source ~/training/bin/activate
  uv pip install torch torchvision torchaudio
  uv pip install accelerate trl deepspeed liger-kernel
  sudo DEBIAN_FRONTEND=noninteractive apt install -y vmtouch
  sudo DEBIAN_FRONTEND=noninteractive apt install -y python3-dev python3.10-dev build-essential

  # Other tools
  sudo DEBIAN_FRONTEND=noninteractive apt install -y htop sysstat iproute2 net-tools infiniband-diags vim
  uv pip install nvitop

run: |
  source ~/training/bin/activate

  MASTER_ADDR=$(echo "$SKYPILOT_NODE_IPS" | head -n1)
  NP=$(($SKYPILOT_NUM_GPUS_PER_NODE * $SKYPILOT_NUM_NODES))

  # accelerate launch --config_file /e2e/fsdp2.yaml --num_machines 2 --num_processes 16 --machine_rank 0 --main_process_ip 10.102.30.188 --main_process_port 29500 /e2e/node_train.py

  # accelerate launch --config_file /e2e/deepspeed_zero3_file.yaml --deepspeed_config_file /e2e/zero3.json --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/node_train.py
  # accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/node_train.py
  accelerate launch --config_file /e2e/fsdp2.yaml --num_machines $SKYPILOT_NUM_NODES --num_processes $NP --machine_rank $SKYPILOT_NODE_RANK --main_process_ip $MASTER_ADDR --main_process_port 29500 /e2e/node_train.py --enable_profiling
  # accelerate launch --config_file /e2e/deepspeed_zero3_file.yaml --deepspeed_config_file /e2e/zero3.json /e2e/node_train.py
  # /home/sky/training/bin/python3 /home/sky/training/bin/accelerate launch --config_file /e2e/fsdp2.yaml --num_machines 2 --num_processes 16 --machine_rank 1 --main_process_ip 10.113.50.29 --main_process_port 29500 /e2e/node_train.py --enable_profiling
  